<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sales Order Form</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <style>
    body { font-family: 'Times New Roman', serif; margin: 0; padding: 40px; background: #f9f9f9; }
    .container { max-width: 800px; margin: auto; background: white; padding: 30px; border: 1px solid #ccc; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    h1 { text-align: center; font-size: 24px; margin-bottom: 30px; font-weight: bold; }
    .field { display: flex; margin-bottom: 12px; font-size: 16px; }
    .label { width: 180px; font-weight: bold; }
    .input { flex: 1; border-bottom: 1px solid #000; padding: 2px 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 30px; font-size: 16px; }
    th { background: #ffc107; padding: 12px; text-align: center; font-weight: bold; }
    td { padding: 10px; border: 1px solid #000; }
    td.input { border: none; border-bottom: 1px solid #000; padding: 8px 5px; }
    .btn { background: #28a745; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 30px auto 0; display: block; width: 200px; }
    .btn:hover { background: #218838; }
    .note { text-align: center; margin-top: 20px; font-size: 12px; color: #666; }
    .password { max-width: 400px; margin: 100px auto; padding: 30px; background: white; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); text-align: center; }
    .password input { width: 80%; padding: 10px; margin: 10px 0; font-size: 16px; }
    .password button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
  </style>
</head>
<body>

  <!-- PASSWORD SCREEN -->
  <div id="passwordScreen" class="password">
    <h2>Enter Password</h2>
    <input type="password" id="passInput" placeholder="Password">
    <button onclick="checkPassword()">Enter</button>
    <p style="color:#666; margin-top:10px;">Hint: smart123</p>
  </div>

  <!-- MAIN FORM -->
  <div id="mainForm" class="container" style="display:none;">
    <h1>Sales Order Form</h1>

    <div class="field"><div class="label">Order No :</div><div class="input"><input type="text" id="orderNo" style="border:none; width:100%; font-size:16px;"></div></div>
    <div class="field"><div class="label">Order Date :</div><div class="input"><input type="date" id="orderDate" style="border:none; width:100%; font-size:16px;"></div></div>
    <div class="field"><div class="label">Name :</div><div class="input"><input type="text" id="name" style="border:none; width:100%; font-size:16px;"></div></div>
    <div class="field"><div class="label">Brand Name :</div><div class="input"><input type="text" id="brand" style="border:none; width:100%; font-size:16px;"></div></div>
    <div class="field"><div class="label">OEM :</div><div class="input"><input type="text" id="oem" style="border:none; width:100%; font-size:16px;"></div></div>
    <div class="field"><div class="label">Mobile Number :</div><div class="input"><input type="text" id="mobile" style="border:none; width:100%; font-size:16px;"></div></div>
    <div class="field"><div class="label">GST No :</div><div class="input"><input type="text" id="gst" style="border:none; width:100%; font-size:16px;"></div></div>
    <div class="field"><div class="label">Address :</div><div class="input"><textarea id="address" rows="2" style="border:none; width:100%; font-size:16px; resize:none;"></textarea></div></div>

    <table>
      <tr><th>Product</th><th>Remark</th></tr>
      <tr><td>Type</td><td class="input"><input type="text" id="type" style="border:none; width:100%;"></td></tr>
      <tr><td>Voltage</td><td class="input"><input type="text" id="voltage" style="border:none; width:100%;"></td></tr>
      <tr><td>Capacity</td><td class="input"><input type="text" id="capacity" style="border:none; width:100%;"></td></tr>
      <tr><td>Maximum Discharge current</td><td class="input"><input type="text" id="discharge" style="border:none; width:100%;"></td></tr>
      <tr><td>Maximum Charging current</td><td class="input"><input type="text" id="charging" style="border:none; width:100%;"></td></tr>
      <tr><td>BMS Type</td><td class="input"><input type="text" id="bms" style="border:none; width:100%;"></td></tr>
      <tr><td>Size</td><td class="input"><input type="text" id="size" style="border:none; width:100%;"></td></tr>
      <tr><td>Casing Type</td><td class="input"><input type="text" id="casing" style="border:none; width:100%;"></td></tr>
      <tr><td>Other Instructions</td><td class="input"><textarea id="instructions" style="border:none; width:100%; height:50px; resize:none;"></textarea></td></tr>
      <tr><td>Payment Terms</td><td class="input"><textarea id="payment" style="border:none; width:100%; height:50px; resize:none;"></textarea></td></tr>
    </table>

    <button class="btn" onclick="saveAndDownload()">Save & Download PDF</button>
    <p class="note">Saved to GitHub â†’ orders/[OrderNo].json</p>
  </div>

  <script>
    const { jsPDF } = window.jspdf;
    const TOKEN = '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';
    const REPO = 'smartechbattery/sales';
    const PATH = 'orders';

    function checkPassword() {
      if (document.getElementById('passInput').value === 'smart123') {
        document.getElementById('passwordScreen').style.display = 'none';
        document.getElementById('mainForm').style.display = 'block';
        document.getElementById('orderDate').value = new Date().toISOString().split('T')[0];
        const editId = new URLSearchParams(window.location.search).get('edit');
        if (editId) { document.getElementById('orderNo').value = editId; loadOrder(editId); }
      } else alert("Wrong password!");
    }
    document.getElementById('passInput').addEventListener('keypress', e => { if (e.key === 'Enter') checkPassword(); });

    async function loadOrder(orderNo) {
      try {
        const res = await fetch(`https://api.github.com/repos/${REPO}/contents/${PATH}/${orderNo}.json`, { headers: { Authorization: `token ${TOKEN}` }});
        if (res.ok) {
          const data = await res.json();
          const content = JSON.parse(atob(data.content));
          Object.keys(content).forEach(k => { const el = document.getElementById(k); if (el) el.value = content[k]; });
        }
      } catch (e) {}
    }

    async function saveAndDownload() {
      const orderNo = document.getElementById('orderNo').value.trim();
      if (!orderNo) return alert("Enter Order No!");

      const data = {};
      document.querySelectorAll('input, textarea').forEach(el => data[el.id] = el.value);
      data.status = 'Pending'; data.createdAt = new Date().toISOString();
      const content = btoa(JSON.stringify(data, null, 2));

      try {
        const existing = await fetch(`https://api.github.com/repos/${REPO}/contents/${PATH}/${orderNo}.json`, { headers: { Authorization: `token ${TOKEN}` }});
        const body = { message: `Update ${orderNo}`, content, branch: 'main' };
        if (existing.ok) body.sha = (await existing.json()).sha;

        await fetch(`https://api.github.com/repos/${REPO}/contents/${PATH}/${orderNo}.json`, {
          method: existing.ok ? 'PUT' : 'POST',
          headers: { Authorization: `token ${TOKEN}` },
          body: JSON.stringify(body)
        });

        alert(`Saved: ${orderNo}`);
        setTimeout(downloadPDF, 500);
      } catch (e) { alert("Save failed: " + e.message); }
    }

    function downloadPDF() {
      html2canvas(document.querySelector('.container'), { scale: 2 }).then(canvas => {
        const img = canvas.toDataURL('image/png');
        const pdf = new jsPDF('p', 'mm', 'a4');
        const w = pdf.internal.pageSize.getWidth();
        const h = (canvas.height * w) / canvas.width;
        pdf.addImage(img, 'PNG', 0, 0, w, h);
        pdf.save(`Sales_Order_${document.getElementById('orderNo').value}.pdf`);
      });
    }

    if (new URLSearchParams(window.location.search).get('pdf') === '1') setTimeout(downloadPDF, 1000);
  </script>
</body>
</html>